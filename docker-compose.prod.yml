version: "3.8"
services:
  # The Main Application (PHP-FPM)
  app:
    build:
      context: .
      args:
        user: ${DOCKER_USER:-laravel}
        uid: ${DOCKER_UID:-1000}
    image: ${DOCKER_IMAGE:-mobidonia/whatsdesk:latest}
    container_name: ${COMPOSE_PROJECT_NAME:-whatsdesk}-app
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - ./:/var/www
    environment:
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USERNAME=${DB_USERNAME:-laravel}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-laravel}
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - FORCE_HTTPS=${FORCE_HTTPS:-true}
    networks:
      - laravel
    healthcheck:
      test: ["CMD", "php", "-r", "exit(0);"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Traefik labels (for Traefik reverse proxy)
    # Uncomment if using Traefik
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.app.rule=Host(`${DOMAIN}`)"
    #   - "traefik.http.routers.app.entrypoints=websecure"
    #   - "traefik.http.routers.app.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.app.loadbalancer.server.port=9000"
    #   - "traefik.docker.network=laravel"

  # The Web Server (Nginx) - Only needed if not using reverse proxy (Caddy/Traefik)
  # Comment out this service if using Coolify, Traefik, or Caddy
  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-whatsdesk}-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./:/var/www
      - ./docker/nginx/conf.d/:/etc/nginx/conf.d/
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      app:
        condition: service_healthy
      reverb:
        condition: service_started
    networks:
      - laravel
    # Traefik labels (if using Traefik, you can remove nginx service)
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.nginx.rule=Host(`${DOMAIN}`)"
    #   - "traefik.http.routers.nginx.entrypoints=websecure"
    #   - "traefik.http.routers.nginx.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.nginx.loadbalancer.server.port=80"
    #   - "traefik.docker.network=laravel"

  # The Database
  db:
    image: mariadb:10.11
    container_name: ${COMPOSE_PROJECT_NAME:-whatsdesk}-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-laravel}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-${DB_PASSWORD}}
      MYSQL_USER: ${DB_USERNAME:-laravel}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - dbdata:/var/lib/mysql
    networks:
      - laravel
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh --connect || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    shm_size: 256mb
    # Database should not be exposed via reverse proxy

  # Laravel Reverb (Websockets)
  reverb:
    image: ${DOCKER_IMAGE:-mobidonia/whatsdesk:latest}
    container_name: ${COMPOSE_PROJECT_NAME:-whatsdesk}-reverb
    restart: unless-stopped
    working_dir: /var/www
    command: php artisan reverb:start --host="0.0.0.0" --port=8080
    volumes:
      - ./:/var/www
    environment:
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USERNAME=${DB_USERNAME:-laravel}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-laravel}
      - REVERB_APP_ID=${REVERB_APP_ID:-whatsdesk}
      - REVERB_APP_KEY=${REVERB_APP_KEY:-whatsdesk-key}
      - REVERB_APP_SECRET=${REVERB_APP_SECRET:-whatsdesk-secret}
      - REVERB_HOST=${REVERB_HOST:-0.0.0.0}
      - REVERB_PORT=${REVERB_PORT:-8080}
      - REVERB_SCHEME=${REVERB_SCHEME:-https}
    depends_on:
      db:
        condition: service_healthy
      app:
        condition: service_healthy
    networks:
      - laravel
    # Traefik labels for WebSocket support (uncomment if using Traefik)
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.reverb.rule=Host(`${DOMAIN}`) && PathPrefix(`/app`)"
    #   - "traefik.http.routers.reverb.entrypoints=websecure"
    #   - "traefik.http.routers.reverb.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.reverb.loadbalancer.server.port=8080"
    #   - "traefik.http.routers.reverb.middlewares=reverb-headers"
    #   - "traefik.http.middlewares.reverb-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
    #   - "traefik.docker.network=laravel"

  # Queue Worker
  queue:
    image: ${DOCKER_IMAGE:-mobidonia/whatsdesk:latest}
    container_name: ${COMPOSE_PROJECT_NAME:-whatsdesk}-queue
    restart: unless-stopped
    working_dir: /var/www
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    volumes:
      - ./:/var/www
    environment:
      - DB_HOST=${DB_HOST:-db}
      - DB_PORT=${DB_PORT:-3306}
      - DB_USERNAME=${DB_USERNAME:-laravel}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_DATABASE=${DB_DATABASE:-laravel}
    depends_on:
      db:
        condition: service_healthy
      app:
        condition: service_healthy
    networks:
      - laravel

networks:
  laravel:
    driver: bridge
    external: ${EXTERNAL_NETWORK:-false}

volumes:
  dbdata:
    driver: local

